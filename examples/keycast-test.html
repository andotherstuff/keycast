<!-- ABOUTME: Test page for Keycast provider authentication and NIP-46 signing -->
<!-- ABOUTME: Tests register/login flow, bunker connection, and event signing -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keycast Provider Test</title>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
    }

    h2 {
      color: #7c3aed;
      margin-top: 0;
    }

    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #1a1a1a;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
    }

    button {
      background: #7c3aed;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 5px 5px 5px 0;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #6d28d9;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    .output {
      background: #1a1a1a;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .status {
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 10px;
    }

    .status.disconnected { background: #444; }
    .status.connecting { background: #f59e0b; }
    .status.connected { background: #10b981; }
    .status.error { background: #ef4444; }
  </style>
</head>
<body>
  <h1>Keycast Provider Test</h1>

  <div class="section">
    <h2>Configuration</h2>
    <label>
      Domain:
      <input type="text" id="domain" value="oauth.divine.video" placeholder="oauth.divine.video">
    </label>
    <label>
      API Base:
      <input type="text" id="apiBase" value="/api" placeholder="/api">
    </label>
  </div>

  <div class="section">
    <h2>Authentication</h2>
    <label>
      Email:
      <input type="email" id="email" value="test@example.com" placeholder="user@example.com">
    </label>
    <label>
      Password:
      <input type="password" id="password" value="testpass123" placeholder="password">
    </label>
    <button id="authBtn">Authenticate</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
    <div class="status disconnected" id="status">disconnected</div>
    <div class="output" id="authOutput"></div>
  </div>

  <div class="section">
    <h2>Public Key</h2>
    <button id="getPubkeyBtn" disabled>Get Public Key</button>
    <div class="output" id="pubkeyOutput"></div>
  </div>

  <div class="section">
    <h2>Sign Event</h2>
    <label>
      Event Content:
      <input type="text" id="eventContent" value="Hello from Keycast!" placeholder="Event content">
    </label>
    <button id="signBtn" disabled>Sign Event</button>
    <div class="output" id="signOutput"></div>
  </div>

  <div class="section">
    <h2>Encryption (NIP-44)</h2>
    <label>
      Target Pubkey (hex):
      <input type="text" id="targetPubkey" placeholder="hex pubkey for encryption">
    </label>
    <label>
      Plaintext:
      <input type="text" id="plaintext" value="Secret message" placeholder="Message to encrypt">
    </label>
    <button id="encryptBtn" disabled>Encrypt</button>
    <button id="decryptBtn" disabled>Decrypt</button>
    <div class="output" id="encryptOutput"></div>
  </div>

  <script type="module">
    import { KeycastProvider } from '../keycast-login/src/providers/KeycastProvider.ts';

    let provider = null;
    let lastCiphertext = null;

    const elements = {
      domain: document.getElementById('domain'),
      apiBase: document.getElementById('apiBase'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      authBtn: document.getElementById('authBtn'),
      disconnectBtn: document.getElementById('disconnectBtn'),
      status: document.getElementById('status'),
      authOutput: document.getElementById('authOutput'),
      getPubkeyBtn: document.getElementById('getPubkeyBtn'),
      pubkeyOutput: document.getElementById('pubkeyOutput'),
      eventContent: document.getElementById('eventContent'),
      signBtn: document.getElementById('signBtn'),
      signOutput: document.getElementById('signOutput'),
      targetPubkey: document.getElementById('targetPubkey'),
      plaintext: document.getElementById('plaintext'),
      encryptBtn: document.getElementById('encryptBtn'),
      decryptBtn: document.getElementById('decryptBtn'),
      encryptOutput: document.getElementById('encryptOutput'),
    };

    function log(elementId, message) {
      const element = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      element.textContent += `[${timestamp}] ${message}\n`;
      element.scrollTop = element.scrollHeight;
    }

    function updateStatus(state) {
      elements.status.textContent = state;
      elements.status.className = `status ${state}`;

      const isConnected = state === 'connected';
      elements.disconnectBtn.disabled = !isConnected;
      elements.getPubkeyBtn.disabled = !isConnected;
      elements.signBtn.disabled = !isConnected;
      elements.encryptBtn.disabled = !isConnected;
      elements.decryptBtn.disabled = !isConnected;
    }

    elements.authBtn.addEventListener('click', async () => {
      try {
        elements.authBtn.disabled = true;
        elements.authOutput.textContent = '';

        log('authOutput', 'Creating KeycastProvider...');
        provider = new KeycastProvider({
          domain: elements.domain.value,
          apiBase: elements.apiBase.value,
        });

        updateStatus('connecting');
        log('authOutput', `Authenticating as ${elements.email.value}...`);

        await provider.authenticate(
          elements.email.value,
          elements.password.value
        );

        updateStatus('connected');
        log('authOutput', 'Authentication successful!');
        log('authOutput', `Provider: ${provider.name}`);

      } catch (error) {
        updateStatus('error');
        log('authOutput', `ERROR: ${error.message}`);
        elements.authBtn.disabled = false;
      }
    });

    elements.disconnectBtn.addEventListener('click', async () => {
      try {
        log('authOutput', 'Disconnecting...');
        await provider.disconnect();
        provider = null;
        updateStatus('disconnected');
        elements.authBtn.disabled = false;
        log('authOutput', 'Disconnected successfully');
      } catch (error) {
        log('authOutput', `ERROR: ${error.message}`);
      }
    });

    elements.getPubkeyBtn.addEventListener('click', async () => {
      try {
        elements.pubkeyOutput.textContent = '';
        log('pubkeyOutput', 'Fetching public key...');

        const pubkey = await provider.getPublicKey();

        log('pubkeyOutput', `Public Key: ${pubkey}`);
        elements.targetPubkey.value = pubkey; // Pre-fill for encryption test

      } catch (error) {
        log('pubkeyOutput', `ERROR: ${error.message}`);
      }
    });

    elements.signBtn.addEventListener('click', async () => {
      try {
        elements.signOutput.textContent = '';
        log('signOutput', 'Creating event...');

        const event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [],
          content: elements.eventContent.value,
        };

        log('signOutput', `Unsigned event: ${JSON.stringify(event, null, 2)}`);
        log('signOutput', 'Signing via NIP-46...');

        const signedEvent = await provider.signEvent(event);

        log('signOutput', `Signed event: ${JSON.stringify(signedEvent, null, 2)}`);

      } catch (error) {
        log('signOutput', `ERROR: ${error.message}`);
      }
    });

    elements.encryptBtn.addEventListener('click', async () => {
      try {
        elements.encryptOutput.textContent = '';
        log('encryptOutput', 'Encrypting with NIP-44...');

        const ciphertext = await provider.nip44Encrypt(
          elements.targetPubkey.value,
          elements.plaintext.value
        );

        lastCiphertext = ciphertext;
        log('encryptOutput', `Ciphertext: ${ciphertext}`);

      } catch (error) {
        log('encryptOutput', `ERROR: ${error.message}`);
      }
    });

    elements.decryptBtn.addEventListener('click', async () => {
      try {
        if (!lastCiphertext) {
          log('encryptOutput', 'ERROR: No ciphertext to decrypt. Encrypt first.');
          return;
        }

        log('encryptOutput', 'Decrypting with NIP-44...');

        const plaintext = await provider.nip44Decrypt(
          elements.targetPubkey.value,
          lastCiphertext
        );

        log('encryptOutput', `Decrypted: ${plaintext}`);

      } catch (error) {
        log('encryptOutput', `ERROR: ${error.message}`);
      }
    });

    // Log initial state
    log('authOutput', 'Ready. Configure domain and authenticate.');
  </script>
</body>
</html>
